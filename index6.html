<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="js/jquery-3.3.1.min.js"></script>
    <script src="js/sockjs.js"></script>
    <script src="js/stomp.js"></script>
    <script>
        let stompClient = null, socket = null;
        let isConnected = false;
        let isSubscribed = false;
        const serverUrl = "http://127.0.0.1:9092/ws";
        const token = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJsb2dpblR5cGUiOiJsb2dpbiIsImxvZ2luSWQiOjEsInJuU3RyIjoidFROeFB4bkVVRWVTeEpQRFkxd1pVVTQ2Sk45R2dWOW8iLCJ1c2VyX25hbWUiOiJhZG1pbiIsImNvbXBhbnlfaWQiOjEsInJvbGVfaWQiOjEwMDAxfQ.FOxe2WqcVu3ZqgDKV4fTixoPpjqczeS5mZDC_AAI8RI';
        const username = 'admin';

        $(document).ready(function () {
            if (window.WebSocket) {
                websocketConfig();
            } else {
                showAlert("错误", "浏览器不支持WebSocket技术通讯.");
            }
        });

        // WebSocket 配置
        function websocketConfig() {
            socket = new SockJS(`${serverUrl}?token=${token}`);
            sockHandle();
            stompClient = Stomp.over(socket);
            stompClient.heartbeat.outgoing = 10000;
            stompClient.heartbeat.incoming = 0;

            const headers = {"userName": username};

            stompClient.connect(headers, onConnect, onError);
        }

        // STOMP 连接成功后的回调函数
        function onConnect(frame) {
            console.log('STOMP: Connected');
            isConnected = true;
        }

        // STOMP 连接失败后的回调函数
        function onError(error) {
            console.log('STOMP: ' + error);
            showAlert("连接失败", "STOMP连接失败，正在尝试重新连接...");
            setTimeout(websocketConfig, 10000); // 重新连接
        }

        // 发送消息
        function sendMsg39() {
            if (isConnected) {
                // if (!isSubscribed) {
                    subscribeToEndpoint("/usr/issued/0x1205/010260000002");
                // }

                const  t9205 = {
                    "channelNo": 1,
                    "endTime": "250220160000",
                    "mainRoleId": "1",
                    "mediaType": 0,   //音视频资源类型
                    "msgId": "0x9205",
                    "startTime": "250220150000",
                    "storageType": 1, //存储器类型
                    "streamType": 1,  ////码流类型
                    "terminalPhones": ["010260000002"],
                    "warnBit1": "0",
                    "warnBit2": "0"
                };;
                stompClient.send("/cims-gateway/0x9205", {}, JSON.stringify(t9205));
            } else {
                showAlert("WebSocket未连接", "请稍后重试.");
            }
        }

        // 订阅某个STOMP端点
        function subscribeToEndpoint(endpoint) {
            stompClient.subscribe(endpoint, function (message) {
                const obj = JSON.parse(message.body);
                console.log("查询资源列表应答，0x0801： " + obj);
                showAlert("查询资源列表", obj.code === 0 ? "成功" : "失败");
            });
            isSubscribed = true;
        }

        // WebSocket 连接事件处理
        function sockHandle() {
            socket.onopen = function () {
                console.log("------连接成功------");
            };

            socket.onmessage = function (event) {
                console.log('-------收到的消息: ' + event.data);
            };

            socket.onclose = function () {
                console.log('--------关闭连接: connection closed.------');
                resetConnectionState();
            };

            socket.onerror = function () {
                showAlert("连接错误", "网络超时或通讯地址错误.");
                disconnect();
            };
        }

        // 重置连接状态
        function resetConnectionState() {
            isConnected = false;
            isSubscribed = false;
        }

        // 关闭websocket
        function disconnect() {
            if (socket !== null) {
                socket.close();
                socket = null;
                resetConnectionState();
            }
        }

        // 简单的弹窗函数
        function showAlert(title, message) {
            alert(`${title}: ${message}`);
        }
    </script>
</head>
<body>
<br/>
<input type="button" id="sendMsg39" name="sendMsg" value="查询资源列表(0x9205)" onclick="sendMsg39();">
</body>
</html>
